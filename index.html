<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plant Care Tracker</title>
  <!-- Tailwind (CDN build) for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0b1220" />
  <style>
    /* Prevent tap highlights and make it feel app-like */
    html, body { height: 100%; background: #0b1220; }
    body { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 18 UMD + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel to transpile JSX in the browser (simplest no-build setup) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ---------- App ----------
    function App() {
      const [plants, setPlants] = useLocalStorage("pct_plants_v1", /** @type {Plant[]} */([]));
      const [filter, setFilter] = useState("due"); // "all" | "due" | "overdue"
      const [search, setSearch] = useState("");
      const [draft, setDraft] = useState(emptyDraft());
      const [now, setNow] = useState(new Date());

      useEffect(() => {
        const t = setInterval(() => setNow(new Date()), 60_000);
        return () => clearInterval(t);
      }, []);

      const visible = useMemo(() => {
        const q = search.trim().toLowerCase();
        return plants
          .map((p) => addComputed(p, now))
          .filter((p) => (q ? p.name.toLowerCase().includes(q) : true))
          .filter((p) => {
            if (filter === "all") return true;
            if (filter === "due") return p.status !== "ok";
            if (filter === "overdue") return p.status === "overdue";
            return true;
          })
          .sort(sortByNextDue);
      }, [plants, filter, search, now]);

      function handleAddPlant(e) {
        e.preventDefault();
        const errors = validateDraft(draft);
        if (errors.length) {
          alert("Please fix the following:\n\n" + errors.join("\n"));
          return;
        }
        const newPlant = {
          id: (crypto && crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random())),
          name: draft.name.trim(),
          notes: draft.notes.trim(),
          tasks: Object.fromEntries(
            Object.entries(draft.tasks)
              .filter(([, t]) => !!t.enabled)
              .map(([k, t]) => [k, { intervalDays: t.intervalDays, lastDate: t.lastDate }])
          ),
        };
        setPlants((prev) => [...prev, newPlant]);
        setDraft(emptyDraft());
      }

      function updatePlant(id, updater) {
        setPlants((prev) => prev.map((p) => (p.id === id ? updater(p) : p)));
      }

      function removePlant(id) {
        if (!confirm("Delete this plant? This cannot be undone.")) return;
        setPlants((prev) => prev.filter((p) => p.id !== id));
      }

      function quickLog(id, key) {
        updatePlant(id, (p) => {
          const copy = JSON.parse(JSON.stringify(p));
          if (!copy.tasks[key]) return copy;
          copy.tasks[key].lastDate = todayISO();
          return copy;
        });
      }

      function editTaskDate(id, key, iso) {
        updatePlant(id, (p) => {
          const copy = JSON.parse(JSON.stringify(p));
          if (!copy.tasks[key]) copy.tasks[key] = { intervalDays: 7, lastDate: iso };
          else copy.tasks[key].lastDate = iso;
          return copy;
        });
      }

      function editTaskInterval(id, key, days) {
        updatePlant(id, (p) => {
          const copy = JSON.parse(JSON.stringify(p));
          if (!copy.tasks[key]) copy.tasks[key] = { intervalDays: days, lastDate: todayISO() };
          else copy.tasks[key].intervalDays = days;
          return copy;
        });
      }

      function exportJSON() {
        const blob = new Blob([JSON.stringify(plants, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `plant-care-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
      }

      function importJSON(ev) {
        const file = ev.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(String(reader.result));
            if (!Array.isArray(data)) throw new Error("Invalid file");
            setPlants(data);
          } catch (e) {
            alert("Could not import: " + e.message);
          }
        };
        reader.readAsText(file);
      }

      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-950 to-slate-900 text-slate-100 p-4 md:p-8">
          <div className="mx-auto max-w-6xl">
            <header className="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
              <div>
                <h1 className="text-3xl md:text-4xl font-bold tracking-tight">Plant Care Tracker</h1>
                <p className="text-slate-300 mt-1">Log watering, feeding, pruning, and more. See what’s due at a glance.</p>
              </div>
              <div className="flex flex-wrap gap-2 items-center">
                <button onClick={exportJSON} className="px-3 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 shadow">Export</button>
                <label className="px-3 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 shadow cursor-pointer">
                  Import
                  <input type="file" accept="application/json" className="hidden" onChange={importJSON} />
                </label>
              </div>
            </header>

            {/* Controls */}
            <section className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
              <input
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                placeholder="Search plants…"
                className="w-full rounded-2xl bg-slate-800/80 focus:bg-slate-800 outline-none px-4 py-2 shadow"
              />
              <div className="flex gap-2">
                <FilterButton active={filter === "due"} onClick={() => setFilter("due")}>Due Soon</FilterButton>
                <FilterButton active={filter === "overdue"} onClick={() => setFilter("overdue")}>Overdue</FilterButton>
                <FilterButton active={filter === "all"} onClick={() => setFilter("all")}>All</FilterButton>
              </div>
              <div className="text-right text-sm text-slate-400 flex items-center justify-end">
                <span>Today: {fmtDate(now)}</span>
              </div>
            </section>

            {/* Add Plant */}
            <section className="mt-6 bg-slate-900/60 rounded-3xl p-4 md:p-6 shadow-lg ring-1 ring-slate-800">
              <h2 className="text-xl font-semibold mb-3">Add a plant</h2>
              <form onSubmit={handleAddPlant} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                <div className="md:col-span-3">
                  <Label>Name</Label>
                  <input
                    value={draft.name}
                    onChange={(e) => setDraft({ ...draft, name: e.target.value })}
                    placeholder="e.g., Night‑Blooming Jasmine"
                    className="w-full rounded-2xl bg-slate-800/80 focus:bg-slate-800 outline-none px-4 py-2"
                  />
                </div>
                <div className="md:col-span-5">
                  <Label>Notes (optional)</Label>
                  <input
                    value={draft.notes}
                    onChange={(e) => setDraft({ ...draft, notes: e.target.value })}
                    placeholder="pot size, cultivar, location, etc."
                    className="w-full rounded-2xl bg-slate-800/80 focus:bg-slate-800 outline-none px-4 py-2"
                  />
                </div>

                <TaskPresetInput label="Water every" value={draft.tasks.water} onChange={(v) => setDraft({ ...draft, tasks: { ...draft.tasks, water: v } })} />
                <TaskPresetInput label="Fertilize every" value={draft.tasks.feed} onChange={(v) => setDraft({ ...draft, tasks: { ...draft.tasks, feed: v } })} />
                <TaskPresetInput label="Prune every" value={draft.tasks.prune} onChange={(v) => setDraft({ ...draft, tasks: { ...draft.tasks, prune: v } })} />
                <TaskPresetInput label="Spray (IPM) every" value={draft.tasks.spray} onChange={(v) => setDraft({ ...draft, tasks: { ...draft.tasks, spray: v } })} />

                <div className="md:col-span-12 flex gap-2">
                  <button className="px-4 py-2 rounded-2xl bg-emerald-600 hover:bg-emerald-500 font-medium shadow">Add</button>
                  <button type="button" onClick={() => setDraft(emptyDraft())} className="px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700">Reset</button>
                </div>
              </form>
            </section>

            {/* Plant list */}
            <section className="mt-8 grid gap-4">
              {visible.length === 0 ? (
                <EmptyState />
              ) : (
                visible.map((p) => (
                  <PlantCard
                    key={p.id}
                    plant={p}
                    onRemove={() => removePlant(p.id)}
                    onQuickLog={quickLog}
                    onEditTaskDate={editTaskDate}
                    onEditTaskInterval={editTaskInterval}
                  />
                ))
              )}
            </section>

            <footer className="mt-10 pt-6 text-xs text-slate-500 border-t border-slate-800/60">
              <p>
                Tip: tap a task’s <span className="font-semibold">Done today</span> button after you water/feed/etc.
                You can import/export JSON to sync or backup.
              </p>
            </footer>
          </div>
        </div>
      );
    }

    // ---------- UI bits ----------
    function FilterButton({ active, onClick, children }) {
      return (
        <button
          onClick={onClick}
          className={
            "px-3 py-2 rounded-2xl shadow transition border " +
            (active
              ? "bg-slate-100 text-slate-900 border-slate-200"
              : "bg-slate-800 hover:bg-slate-700 text-slate-100 border-slate-700")
          }
        >
          {children}
        </button>
      );
    }

    function Label({ children }) {
      return <label className="block text-sm text-slate-300 mb-1">{children}</label>;
    }

    function TaskPresetInput({ label, value, onChange }) {
      return (
        <div className="md:col-span-1">
          <Label>{label}</Label>
          <div className="flex items-center gap-2">
            <input type="checkbox" checked={value.enabled} onChange={(e) => onChange({ ...value, enabled: e.target.checked })} />
            <input
              type="number"
              min={1}
              placeholder="days"
              className="w-24 rounded-2xl bg-slate-800/80 focus:bg-slate-800 outline-none px-3 py-2"
              value={value.intervalDays ?? ""}
              onChange={(e) => onChange({ ...value, intervalDays: Number(e.target.value) })}
            />
          </div>
        </div>
      );
    }

    function PlantCard({ plant, onRemove, onQuickLog, onEditTaskDate, onEditTaskInterval }) {
      return (
        <div className="rounded-3xl bg-slate-900/70 p-4 md:p-6 shadow ring-1 ring-slate-800">
          <div className="flex items-start justify-between gap-3">
            <div>
              <h3 className="text-lg font-semibold tracking-tight">{plant.name}</h3>
              {plant.notes && <p className="text-slate-400 text-sm mt-0.5">{plant.notes}</p>}
            </div>
            <button onClick={onRemove} className="text-xs px-2 py-1 rounded-xl bg-red-600/90 hover:bg-red-500" title="Delete plant">Delete</button>
          </div>

          <div className="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            {["water", "feed", "prune", "spray"].map((key) => (
              <TaskCard
                key={key}
                plant={plant}
                k={key}
                onQuickLog={onQuickLog}
                onEditTaskDate={onEditTaskDate}
                onEditTaskInterval={onEditTaskInterval}
              />
            ))}
          </div>
        </div>
      );
    }

    function TaskCard({ plant, k, onQuickLog, onEditTaskDate, onEditTaskInterval }) {
      const t = plant.tasks[k];
      const label = taskLabel(k);
      const statusStyles = {
        ok: "bg-emerald-900/40 text-emerald-300 border-emerald-800",
        due: "bg-amber-900/30 text-amber-300 border-amber-800",
        overdue: "bg-rose-900/30 text-rose-300 border-rose-800",
      };

      if (!t) {
        return (
          <div className="rounded-2xl bg-slate-800/60 p-4 border border-slate-700">
            <p className="text-slate-300 font-medium">{label}</p>
            <p className="text-slate-400 text-sm mt-1">Not tracking</p>
            <button onClick={() => onEditTaskInterval(plant.id, k, 7)} className="mt-3 text-xs px-3 py-1 rounded-xl bg-slate-700 hover:bg-slate-600">Start (7d)</button>
          </div>
        );
      }

      return (
        <div className={`rounded-2xl p-4 border ${statusStyles[plant.statusByTask[k]]}`}>
          <div className="flex items-center justify-between gap-2">
            <p className="text-slate-100 font-medium">{label}</p>
            <button onClick={() => onQuickLog(plant.id, k)} className="text-xs px-3 py-1 rounded-xl bg-slate-100 text-slate-900 hover:bg-slate-200">Done today</button>
          </div>

          <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
            <div>
              <p className="text-slate-400">Last</p>
              <input type="date" value={t.lastDate || ""} onChange={(e) => onEditTaskDate(plant.id, k, e.target.value)} className="mt-1 w-full rounded-xl bg-slate-800/80 focus:bg-slate-800 px-2 py-1" />
            </div>
            <div>
              <p className="text-slate-400">Every (days)</p>
              <input type="number" min={1} value={t.intervalDays} onChange={(e) => onEditTaskInterval(plant.id, k, Number(e.target.value))} className="mt-1 w-full rounded-xl bg-slate-800/80 focus:bg-slate-800 px-2 py-1" />
            </div>
          </div>

          <div className="mt-3 text-sm">
            <p className="text-slate-300">Next due: <span className="font-semibold">{fmtDate(new Date(plant.nextDueByTask[k]))}</span></p>
            <p className="text-slate-400">{plant.humanByTask[k]}</p>
          </div>
        </div>
      );
    }

    function EmptyState() {
      return (
        <div className="rounded-3xl border border-dashed border-slate-700 p-10 text-center text-slate-400">
          <p className="text-lg">No plants yet.</p>
          <p className="mt-1">Add your first plant above. Try tracking watering every 2–3 days and fertilizing every 14 days.</p>
        </div>
      );
    }

    // ---------- Types (JSDoc) & helpers ----------
    /** @typedef {"water"|"feed"|"prune"|"spray"} TaskKey */
    /** @typedef {"ok"|"due"|"overdue"} Status */
    /** @typedef {{intervalDays:number, lastDate?:string}} Task */
    /** @typedef {{id:string, name:string, notes:string, tasks: Partial<Record<TaskKey, Task>>}} Plant */

    function taskLabel(k) { return ({ water: "Water", feed: "Fertilize", prune: "Prune", spray: "Spray (IPM)" })[k] || k; }

    function todayISO(d = new Date()) {
      const tzOffset = d.getTimezoneOffset();
      const local = new Date(d.getTime() - tzOffset * 60_000);
      return local.toISOString().slice(0, 10);
    }
    function addDays(dateISO, days) {
      const d = new Date(dateISO + "T00:00:00");
      d.setDate(d.getDate() + days);
      return d.getTime();
    }
    function humanDelta(ms, now = new Date()) {
      const days = Math.round((ms - now.getTime()) / 86_400_000);
      if (days > 1) return `${days} days from now`;
      if (days === 1) return "tomorrow";
      if (days === 0) return "today";
      if (days === -1) return "yesterday";
      return `${Math.abs(days)} days ago`;
    }

    function addComputed(p, now) {
      const nextByTask = {}; const statusByTask = {}; const humanByTask = {};
      Object.keys(p.tasks || {}).forEach((k) => {
        const t = p.tasks[k];
        const base = t.lastDate || todayISO(now);
        const next = addDays(base, t.intervalDays);
        nextByTask[k] = next;
        const status = next < now.getTime() ? "overdue" : next - now.getTime() <= 2 * 86_400_000 ? "due" : "ok"; // 2-day soon window
        statusByTask[k] = status;
        humanByTask[k] = humanDelta(next, now);
      });
      const allNext = Object.values(nextByTask);
      const soonest = allNext.length ? Math.min(...allNext) : now.getTime();
      const worstStatus = Object.values(statusByTask).sort((a, b) => rank(b) - rank(a))[0] || "ok";
      return { ...p, nextDue: soonest, nextDueByTask: nextByTask, status: worstStatus, statusByTask, humanByTask };
    }
    function rank(s) { return s === "overdue" ? 2 : s === "due" ? 1 : 0; }
    function sortByNextDue(a, b) { if (rank(a.status) !== rank(b.status)) return rank(b.status) - rank(a.status); return a.nextDue - b.nextDue; }

    // Draft types
    function emptyDraft() {
      return {
        name: "",
        notes: "",
        tasks: {
          water: { enabled: true, intervalDays: 3 },
          feed: { enabled: true, intervalDays: 14 },
          prune: { enabled: false, intervalDays: 30 },
          spray: { enabled: false, intervalDays: 7 },
        },
      };
    }
    function validateDraft(d) {
      const errs = [];
      if (!d.name.trim()) errs.push("Name is required.");
      Object.entries(d.tasks).forEach(([k, t]) => {
        if (t.enabled && (!t.intervalDays || t.intervalDays < 1)) errs.push(`${k}: interval must be ≥ 1 day`);
      });
      return errs;
    }

    // LocalStorage hook
    function useLocalStorage(key, initial) {
      const [value, setValue] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial; } catch { return initial; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(value)); } catch {} }, [key, value]);
      return [value, setValue];
    }

    function fmtDate(d) { return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" }); }

    // Mount
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
